<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Places API Test</title>
    <!-- Load Tailwind CSS for quick styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Set Inter font */
        body { font-family: 'Inter', sans-serif; }
        /* Style for the loading indicator */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: none;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 sm:p-8">

    <div class="max-w-xl mx-auto bg-white p-6 sm:p-8 rounded-xl shadow-2xl space-y-6">
        <h1 class="text-3xl font-bold text-gray-900 text-center">
            Places API Test Runner
        </h1>
        <p class="text-sm text-gray-500 text-center">
            This tool uses Google's Find Place endpoint to search for restaurants.
            <strong class="text-red-500">Remember to replace the API Key below.</strong>
        </p>

        <!-- Search Form -->
        <div class="space-y-4">
            <div>
                <label for="query" class="block text-sm font-medium text-gray-700 mb-1">Search Term (e.g., pizza)</label>
                <input type="text" id="query" value="Taco" placeholder="Restaurant name or type" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div>
                <label for="location" class="block text-sm font-medium text-gray-700 mb-1">Current Location (Latitude,Longitude)</label>
                <!-- Use a default San Francisco location for initial testing -->
                <input type="text" id="location" value="37.7749,-122.4194" placeholder="e.g., 34.0522,-118.2437" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                <p class="text-xs text-gray-400 mt-1">Default: San Francisco, CA</p>
            </div>
            
            <button id="search-btn" class="w-full bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-150 flex items-center justify-center">
                Search for Restaurants
                <div id="loading" class="loader ml-3"></div>
            </button>
        </div>

        <!-- Results Section -->
        <div class="mt-8 pt-6 border-t border-gray-200">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">API Response</h2>
            <div id="results" class="space-y-3 p-4 bg-gray-100 rounded-lg max-h-96 overflow-y-auto">
                <p class="text-gray-500 italic" id="initial-message">Enter a search query and click "Search" to see results.</p>
            </div>
        </div>
    </div>

    <script>
        // CRITICAL: Replace 'YOUR_GOOGLE_PLACES_API_KEY' with your actual API key
        const API_KEY = 'AIzaSyDPb-widA8JqLCvj0P1hyR6jmN8XlqFzw4';
        const BASE_URL = 'https://maps.googleapis.com/maps/api/place/findplacefromtext/json';
        
        const searchBtn = document.getElementById('search-btn');
        const queryInput = document.getElementById('query');
        const locationInput = document.getElementById('location');
        const resultsDiv = document.getElementById('results');
        const loadingSpinner = document.getElementById('loading');
        const initialMessage = document.getElementById('initial-message');

        // Helper function for exponential backoff (retry logic)
        async function fetchWithRetry(url, options = {}, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429 && i < maxRetries - 1) {
                        // Too Many Requests, calculate backoff delay
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue; // Retry the request
                    }
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    console.error("Fetch attempt failed:", error);
                    if (i === maxRetries - 1) throw error; // Re-throw if last attempt failed
                }
            }
        }

        async function fetchPlaces() {
            const query = queryInput.value.trim();
            const location = locationInput.value.trim();

            if (API_KEY === 'YOUR_GOOGLE_PLACES_API_KEY') {
                displayError("Please replace 'YOUR_GOOGLE_PLACES_API_KEY' in the script with your actual Google API key.");
                return;
            }

            if (!query || !location) {
                displayError("Please enter both a search query and a location (lat,lng).");
                return;
            }

            // Set UI to loading state
            loadingSpinner.style.display = 'block';
            searchBtn.disabled = true;
            resultsDiv.innerHTML = '';
            initialMessage.style.display = 'none';

            // Construct the API URL
            // We use 'textquery' for the search term and 'locationbias' to prioritize nearby results
            const url = `${BASE_URL}?input=${encodeURIComponent(query)}&inputtype=textquery&fields=photos,formatted_address,name,rating,geometry,place_id&locationbias=circle:50000@${location}&key=${API_KEY}`;
            
            try {
                const response = await fetchWithRetry(url);
                const data = await response.json();

                if (data.status !== 'OK' && data.status !== 'ZERO_RESULTS') {
                    displayError(`API Status: ${data.status}. Message: ${data.error_message || 'Check API Key and browser console.'}`);
                    return;
                }

                if (data.candidates && data.candidates.length > 0) {
                    data.candidates.forEach(place => {
                        const placeHtml = `
                            <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                                <p class="font-bold text-lg text-blue-600">${place.name}</p>
                                <p class="text-sm text-gray-600">${place.formatted_address}</p>
                                <p class="text-xs text-gray-500">Rating: ${place.rating || 'N/A'}</p>
                                <p class="text-xs text-gray-500">Place ID: ${place.place_id}</p>
                            </div>
                        `;
                        resultsDiv.insertAdjacentHTML('beforeend', placeHtml);
                    });
                } else {
                    resultsDiv.innerHTML = '<p class="text-gray-500">No restaurants found for this query and location.</p>';
                }

            } catch (error) {
                console.error("Error fetching data:", error);
                displayError(`Failed to connect to API. See console for details. Error: ${error.message}`);
            } finally {
                // Reset UI state
                loadingSpinner.style.display = 'none';
                searchBtn.disabled = false;
            }
        }

        function displayError(message) {
            resultsDiv.innerHTML = `<div class="bg-red-100 p-3 rounded-lg text-red-700 font-medium">${message}</div>`;
        }

        searchBtn.addEventListener('click', fetchPlaces);
    </script>
</body>
</html>